(function(){"use strict";var e;e=angular.module("ProtocolService",["CompoundService","AthleteService","BTCService","PubNubService"]),e.factory("Protocol",["Compounds","Athlete","BTCrate","PubNub","$http","$rootScope","$timeout",function(e,t,o,r,n,i,a){var u,l,c,s;return i.$on("UpdateAthlete",function(e,o){return t=o}),l=function(){function o(o,r){var n,a,u,l,c,s,d,h,p,m,f,g,v,y,b,A;y=this,g=function(){return r._save()},b=function(){var e,t;if(null!=y.compound)return t=new Worker("assets/js/Worker_CalculateLevels.js"),t.onmessage=function(e){return y.levels=e.data.levels,y.dose=Math.ceil(e.data.dose),y.loadingDose=Math.ceil(e.data.loadingDose),y.variance=100*(1-y.adjustedActiveTarget/e.data.max),i.$evalAsync(function(){var e,t;return t=24*(y.startDay-1),e=function(e,r,n){var i;return i={hour:t+r},i[o]=Math.round(e),i},y.graphDataProvider=_.map(y.levels,e),null!=y.graph?(y.graph.dataProvider=y.graphDataProvider,setTimeout(function(){return y.graph.validateData()}),y.graph.zoomToIndexes(1,y.graph.dataProvider.length-2)):void 0}),y.protocol._update()},e=y.adjustedActiveTarget,t.postMessage({halfLife:y.compound.halfLife,bioavailability:y.compound.bioavailability,duration:y.duration,interval:y.interval,density:y.density,activeTarget:e})},b=_.debounce(b,250),d=null,Object.defineProperty(this,"$$hashkey",{enumerable:!1}),f=r,Object.defineProperty(this,"protocol",{get:function(){return f},set:function(){}}),a=e(o),Object.defineProperty(this,"compound",{enumerable:!0,get:function(){return a},set:function(){}}),n=a.ffmiStandard,Object.defineProperty(this,"activeTarget",{enumerable:!0,get:function(){return n},set:function(e){return n!==e?(n=e,g(),b()):void 0}}),u=a.density/2,Object.defineProperty(this,"density",{enumerable:!0,get:function(){return u},set:function(e){return e>a.density?u=a.density:u!==e?(u=5*Math.round(e/5),g(),b()):void 0}}),h=a.ffmiInterval,Object.defineProperty(this,"interval",{enumerable:!0,get:function(){return h},set:function(e){return h!==e?(h=Math.round(e),g(),b()):void 0}}),v=1,Object.defineProperty(this,"startDay",{enumerable:!0,get:function(){return v},set:function(e){return v!==e?(v=Math.round(e),g(),b()):void 0}}),c=a.ffmiInterval,Object.defineProperty(this,"duration",{enumerable:!0,get:function(){return c},set:function(e){return c!==e?(e>140&&(e=Math.floor(140/this.interval)*this.interval),c=Math.round(e/this.interval)*this.interval,g(),b()):void 0}}),Object.defineProperty(this,"graphDataProvider",{enumerable:!1,writable:!0}),s=null,Object.defineProperty(this,"graph",{get:function(){return s},set:function(e){return s=AmCharts.makeChart(e[0],{type:"serial",theme:"none",pathToImages:"http://cdn.amcharts.com/lib/3/images/",categoryField:"hour",autoMargins:!1,marginBottom:0,marginLeft:0,marginRight:0,marginTop:0,borderAlpha:0,chartCursor:{selectWithoutZooming:!0,zoomable:!1,zooming:!1},zoomOutButtonImage:"",zoomOutText:"",graphs:[{fillAlphas:1,fillColors:this.compound.color,id:"AmGraph-1",lineAlpha:0,title:"Rate of Compound Release",type:"line",valueField:this.compound.id,balloonFunction:function(e,t){var o,r;return o=Math.floor(parseInt(e.category)/24)+1,r=Math.floor((parseInt(e.category)/24-o+1)/(1/24)),e.values.value+"mg<br>Day: "+o+" Hour: "+r}}],valueAxes:[{id:"ValueAxis-1",title:"Axis title",axisAlpha:0,gridAlpha:0}],categoryAxis:{axisAlpha:0,gridAlpha:0,minorGridAlpha:0},dataProvider:[]}),y=this,i.$evalAsync(function(){return y.graph.dataProvider=y.graphDataProvider,setTimeout(function(){return y.graph.validateData()}),y.graph.zoomToIndexes(1,y.graph.dataProvider.length-2)})}}),p=null,Object.defineProperty(this,"levels",{get:function(){return p&&0!==p.length||b(),p},set:function(e){return p=e}}),A=0,Object.defineProperty(this,"variance",{get:function(){return A},set:function(e){return A=e}}),l=0,Object.defineProperty(this,"dose",{get:function(){return l},set:function(e){return l=e}}),Object.defineProperty(this,"doseVolume",{get:function(){return this.dose/u},set:function(e){}}),m=0,Object.defineProperty(this,"loadingDose",{get:function(){return m},set:function(e){return m=e}}),Object.defineProperty(this,"loadingVolume",{get:function(){return this.loadingDose/u},set:function(e){}}),Object.defineProperty(this,"totalVolume",{get:function(){return this.doseVolume*(this.duration/this.interval)+this.loadingVolume},set:function(e){}}),Object.defineProperty(this,"adjustedActiveTarget",{get:function(){return Math.round(this.activeTarget*(t.ffmi/25))},set:function(e){return this.activeTarget=Math.round(parseFloat(e)*(25/t.ffmi))}}),b(),g()}return o}(),u=function(){function n(){var n,u,c,s,d,h,p,m,f,g,v,y,b,A,P,D;A=this,y=function(){return A.owner===t._id&&A.components.length>0?r("ProtocolService : Set Protocol",A):void 0},this._save=y=_.debounce(y,5e3),D=function(){var t,o,r,n,u,l,c,s,d,h,p,m,f,g,v,y,b;A.priceUSD=0,n={},g=_.groupBy(A.components,function(e){return e.startDay+":"+e.interval+":"+e.duration+":"+e.compound.mode+":"+e.dilution}),f=_.groupBy(_.values(g),function(e){var t,o,r,n;for(t="",o=0,r=e.length;r>o;o++)n=e[o],t+=n.compound.id+"["+n.activeTarget+"]";return t}),_.each(_.values(f),function(e,t){var o,r,i,a,u,l,c,s,d,h,p,m;for(u={id:String.fromCharCode(65+t),schedules:[],compounds:{},filler:0,totalVolume:0},l=0,s=e.length;s>l;l++){for(p=e[l],m={startDay:p[0].startDay,interval:p[0].interval,duration:p[0].duration,doses:p[0].duration/p[0].interval,loadingVolume:0,doseVolume:0,totalVolume:0},c=0,d=p.length;d>c;c++)h=p[c],m.doseVolume+=h.doseVolume,m.loadingVolume+=h.loadingVolume,null==u.compounds[h.compoundId]&&(u.compounds[h.compound.id]=0),u.compounds[h.compound.id]+=h.totalVolume*(h.density/h.compound.density),u.filler+=h.totalVolume*(1-h.density/h.compound.density),A.priceUSD+=h.totalVolume*h.compound.density*h.compound.price*(h.density/h.compound.density);o=Math.ceil(10*m.doseVolume)/10,r=o/m.doseVolume,i=o-m.doseVolume,a=i/m.doseVolume,m.doseVolume=o,m.loadingVolume=Math.ceil(m.loadingVolume*r*10)/10,m.totalVolume=m.loadingVolume+m.doseVolume*m.doses,u.totalVolume+=m.totalVolume,u.filler+=m.totalVolume*a,u.schedules.push(m)}return A.priceUSD+=.025*u.filler,A.priceUSD+=2*Math.ceil(u.totalVolume/30),n[u.id]=u}),A.formulations=n,y=[],b=[];for(u in A.formulations)for(r=A.formulations[u],d=r.schedules,l=0,s=d.length;s>l;l++)for(v=d[l],o=c=h=v.startDay,p=v.duration+v.startDay,m=v.interval;m>0?p>=c:c>=p;o=c+=m)null==y[o]&&(y[o]=[]),y[o].push(r.id),y[o]=_.uniq(y[o]),b[o]=v.doseVolume;return A.schedule=y,t=0,_.each(b,function(e){return null!=e?t+=Math.ceil(e/3):void 0}),A.accessoriesQty=t,A.accessoriesPriceUSD=.2*t,A.accessoriesPriceUSD+=5,A.accessoriesPriceUSD+=2,A.priceUSD+=2*A.accessoriesPriceUSD,i.$evalAsync(function(){var t,r,n,i,u,l,c,s,d,h,p,m,f,g,v,y,b,P,D,C,O,j,M,V,x,S;if(null!=A.graph){for(A.graph.graphs=[],i=[],j=A.components,d=0,h=j.length;h>d;d++)S=j[d],i.push(S.compound.id);for(M=_.uniq(i),y=0,p=M.length;p>y;y++)c=M[y],l=new AmCharts.AmGraph,l.fillAlphas=1,l.fillColors=e(c).color,l.lineAlpha=0,l.title="Rate of Compound Release",l.valueField=c,l.balloonFunction=function(e,t){var r;return o=Math.floor(parseInt(e.category)/24)+1,r=Math.floor((parseInt(e.category)/24-o+1)/(1/24)),e.values.value+"mg - Day: "+o+" Hour: "+r},A.graph.addGraph(l);for(u=Array.apply(null,Array(6240)).map(Object),V=A.components,P=0,m=V.length;m>P;P++)S=V[P],_.each(S.levels,function(e,t,o){return _.isNumber(u[24*(S.startDay-1)+t][S.compoundId])||(u[24*(S.startDay-1)+t][S.compound.id]=0),u[24*(S.startDay-1)+t][S.compound.id]+=Math.round(e)});for(v=Array.apply(null,Array(6240)).map(Object),_.each(u,function(e,t,o){return e.hour=t,v[t]=e}),v=_.dropRightWhile(v,function(e){return 1===Object.keys(e).length}),A.graph.dataProvider=v,A.graph.validateData(),x=A.graph.graphs,D=0,f=x.length;f>D;D++)l=x[D],l.connect=!1;if(A.graph.drawChart(),a(function(){return 0===A.graph.chartData.length?A._update():void 0}),null!=A.pharmacodynamics){for(A.pharmacodynamics.graphs=[],l=new AmCharts.AmGraph,l.fillColors=l.lineColor="rgba(255, 67, 81, 1)",l.title="Androgen Receptor Activity",l.valueField="androgen",l.type="smoothedLine",l.lineThickness=1,l.fillAlphas=1,l.connect=!1,l.balloonFunction=function(e,t){var r;return o=Math.floor(parseInt(e.category)/24)+1,r=Math.floor((parseInt(e.category)/24-o+1)/(1/24)),e.values.value+"x - Day: "+o+" Hour: "+r},A.pharmacodynamics.addGraph(l),l=new AmCharts.AmGraph,l.fillColors=l.lineColor="rgba(27, 154, 247, 1)",l.title="Progesterone Receptor Activity",l.valueField="progesterone",l.type="smoothedLine",l.lineThickness=1,l.fillAlphas=1,l.connect=!1,l.balloonFunction=function(e,t){var r;return o=Math.floor(parseInt(e.category)/24)+1,r=Math.floor((parseInt(e.category)/24-o+1)/(1/24)),e.values.value+"x - Day: "+o+" Hour: "+r},A.pharmacodynamics.addGraph(l),l=new AmCharts.AmGraph,l.fillColors=l.lineColor="rgba(250, 136, 41, 1)",l.title="Estrogen α Receptor Activity",l.valueField="estrogenAlpha",l.type="smoothedLine",l.lineThickness=1,l.fillAlphas=1,l.connect=!1,l.balloonFunction=function(e,t){var r;return o=Math.floor(parseInt(e.category)/24)+1,r=Math.floor((parseInt(e.category)/24-o+1)/(1/24)),e.values.value+"x - Day: "+o+" Hour: "+r},A.pharmacodynamics.addGraph(l),l=new AmCharts.AmGraph,l.fillColors=l.lineColor="rgba(254, 211, 62, 1)",l.title="Estrogen β Receptor Activity",l.valueField="estrogenBeta",l.type="smoothedLine",l.lineThickness=1,l.fillAlphas=1,l.connect=!1,l.balloonFunction=function(e,t){var r;return o=Math.floor(parseInt(e.category)/24)+1,r=Math.floor((parseInt(e.category)/24-o+1)/(1/24)),e.values.value+"x - Day: "+o+" Hour: "+r},A.pharmacodynamics.addGraph(l),l=new AmCharts.AmGraph,l.lineColor="rgba(81, 230, 80, 1)",l.title="Gucocorticoid Receptor Activity",l.valueField="glucocorticoid",l.type="smoothedLine",l.lineThickness=1,l.fillAlphas=1,l.connect=!1,l.balloonFunction=function(e,t){var r;return o=Math.floor(parseInt(e.category)/24)+1,r=Math.floor((parseInt(e.category)/24-o+1)/(1/24)),e.values.value+"x - Day: "+o+" Hour: "+r},A.pharmacodynamics.addGraph(l),A.pharmacodynamics.dataProvider=O=[],C=0,g=v.length;g>C;C++){s=v[C],t={hour:s.hour,androgen:0,progesterone:0,estrogenAlpha:0,estrogenBeta:0,glucocorticoid:0};for(n in s)b=s[n],n.startsWith("C-")&&(r=e(n),t.androgen+=b*r.androgenReceptor,t.progesterone+=b*r.progesteroneReceptor,t.estrogenAlpha+=b*r.estrogenAlphaReceptor,t.estrogenBeta+=b*r.estrogenBetaReceptor,t.glucocorticoid+=b*r.glucocorticoidReceptor);t.androgen=Math.round(t.androgen),t.progesterone=Math.round(t.progesterone),t.estrogenAlpha=Math.round(t.estrogenAlpha),t.estrogenBeta=Math.round(t.estrogenBeta),t.glucocorticoid=Math.round(t.glucocorticoid),O.push(t)}return A.pharmacodynamics.validateData(),a(function(){return 0===A.pharmacodynamics.chartData.length?A._update():void 0})}}})},this._update=D=_.debounce(D,250),p=null,Object.defineProperty(this,"$$hashkey",{enumerable:!1}),m="",Object.defineProperty(this,"owner",{enumerable:!0,get:function(){return m},set:function(e){return m!==e?(m=e,y()):void 0}}),P="",Object.defineProperty(this,"title",{enumerable:!0,get:function(){return P},set:function(e){return P!==e?(P=e,y()):void 0}}),u="",Object.defineProperty(this,"description",{enumerable:!0,get:function(){return u},set:function(e){return u!==e?(u=e,y()):void 0}}),t.ffmi<=20&&(c="Beginner"),25>(v=t.ffmi)&&v>20&&(c="Intermediate"),t.ffmi>25&&(c="Advanced"),Object.defineProperty(this,"experience",{enumerable:!0,get:function(){return c},set:function(e){return c!==e?(c=e,y()):void 0}}),d="Hypertrophy",Object.defineProperty(this,"goal",{enumerable:!0,get:function(){return d},set:function(e){return d!==e?(d=e,y()):void 0}}),n=[],Object.defineProperty(this,"components",{enumerable:!0,get:function(){return n},set:function(e){return n!==e?(n=e,y()):void 0}}),h=null,Object.defineProperty(this,"graph",{get:function(){return h},set:function(e){return h=AmCharts.makeChart(e[0],{type:"serial",pathToImages:"http://cdn.amcharts.com/lib/3/images/",categoryField:"hour",autoMargins:!1,marginBottom:0,marginLeft:0,marginRight:0,marginTop:0,borderAlpha:0,chartCursor:{selectWithoutZooming:!0,zoomable:!1,zooming:!1},zoomOutButtonImage:"",zoomOutText:"",graphs:[{connect:!1}],valueAxes:[{id:"ValueAxis-1",stackType:"regular",title:"Axis title",axisAlpha:0,gridAlpha:0}],categoryAxis:{axisAlpha:0,gridAlpha:0,minorGridAlpha:0},dataProvider:[]}),A._update()}}),f=null,Object.defineProperty(this,"pharmacodynamics",{get:function(){return f},set:function(e){return f=AmCharts.makeChart(e[0],{type:"serial",pathToImages:"http://cdn.amcharts.com/lib/3/images/",categoryField:"hour",autoMargins:!1,marginBottom:0,marginLeft:0,marginRight:0,marginTop:0,borderAlpha:0,chartCursor:{selectWithoutZooming:!0,zoomable:!1,zooming:!1},zoomOutButtonImage:"",zoomOutText:"",graphs:[],valueAxes:[{id:"ValueAxis-1",title:"Axis title",axisAlpha:0,gridAlpha:0}],categoryAxis:{axisAlpha:0,gridAlpha:0,minorGridAlpha:0},dataProvider:[]}),A._update()}}),g=0,Object.defineProperty(this,"priceUSD",{enumerable:!0,get:function(){return 0===this.components.length?0:g},set:function(e){return g!==e?g=e:void 0}}),Object.defineProperty(this,"priceBTC",{get:function(){return this.priceUSD*o()},set:function(){}}),s=[],Object.defineProperty(this,"formulations",{enumerable:!0,get:function(){return 0===this.components.length||s||A._update(),s},set:function(e){return s!==e?s=e:void 0}}),b=[],Object.defineProperty(this,"schedule",{get:function(){return 0===this.components.length||b||D(),b},set:function(e){return b!==e?b=e:void 0}}),Object.defineProperty(this,"length",{enumerable:!0,get:function(){return b.length-1},set:function(){return D()}}),i.$on("ProtocolService : Update Protocol",function(e,t){return t._id===A._id?i.$evalAsync(function(){return _.extend(A,t),A.components=[],_.each(t.components,function(e){var t;return t=new l(e.compound.id,A),_.extend(t,e),A.components.push(t)})}):void 0}),i.$on("ProtocolService : Set Protocol Complete",function(e,t){return t.id===A._id?A._rev=t.rev:void 0})}return n.prototype.addComponent=function(e){return this.components.unshift(new l(e,this)),this._update(),this._save()},n.prototype.removeComponent=function(e){return this.components.splice(e,1),this._update(),this._save()},n}(),window.ProtocolService=c={},s=null,i.$on("ProtocolService : New Protocol Complete",function(e,o){return i.$evalAsync(function(){return s._id=o._id,s.owner=t._id,c[o._id]=s})}),i.$on("ProtocolService : Search Results",function(e,t){}),function(e,t){return null==t&&(t=!1),null==e||null==c[e]||t?null==e?(s=new u,r("ProtocolService : New Protocol",s),s):t?t?(r("ProtocolService : Delete Protocol",c[e]),delete c[e]):void 0:(c[e]=new u,c[e]._id=e,r("ProtocolService : Get Protocol",c[e]),c[e]):c[e]}}])}).call(this);